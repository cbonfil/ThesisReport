% Chapter Template

\chapter{Test Cases: Analytic vs. Numerical Solutions} % Main chapter title

\label{Chapter4} % Change X to a consecutive number; for referencing this chapter elsewhere, use \ref{ChapterX}

\lhead{Chapter 4. \emph{Test Cases: Analytic vs. Numerical Solutions}} % Change X to a consecutive number; this is for the header on each page - perhaps a shortened title

In the past chapter we have gone through the details of how to solve drift-diffusion and Poisson's equation using finite difference method. Now we can do steady state and transient analysis and compare the results with analytical solutions as well as a commercially available simulator called 'COMSOL Multiphysics' which uses finite element method instead of finite difference. Following test cases were made to ensure that the key parts of the finite difference scheme runs properly and does not produce unexpected results. 

\section{Solution for Closed Boundary}
In this test case we will examine the accuracy of the finite difference solution in steady state. In order to do this we can use a simple 1-D problem where we have a finite number of negatively charged particles over a certain distance subject to constant electric field. This is the same problem we have solved analytically in section 3.3.1. We also assume that the charge density is very low and does not affect the electric field. Both ends of the simulation domain have no flow boundary conditions for charged particles. The solution process requires an initial distribution for charge density over the area. For this problem the density of the negative particles was initialized to be uniform over the entire area. Since our differential equations are uncoupled solving Poisson's equation only once is sufficient to determine the electric field over the course of the entire simulation. Figures \ref{5E} and \ref{5pot} show the potential and the electric field distribution over the entire simulation area calculated from Poisson's equation using finite difference. 

\begin{figure}
\centering
\includegraphics[scale=0.8]{5101}
\caption{Potential Distribution} 
\label{5pot}
\end{figure}

\begin{figure}
\centering
\includegraphics[scale=0.8]{5102}
\caption{Electric Field Distribution} 
\label{5E}
\end{figure}

\clearpage

Figure  \ref{5ss} has two simulation results as well as the exact solution of this problem. The green line represents the result given by the finite difference method once the transient response reaches steady state. It can be seen from the graph that the steady state solution generated by both COMSOL and finite difference matched the analytical solution.

\begin{figure}
\centering
\includegraphics[scale=0.8]{511}
\caption{Steady State Negative Charge Density} 
\label{5ss}
\end{figure}

\begin{figure}[!htp]
\centering
\includegraphics[scale=0.8]{513}
\caption{Finite Difference Drift and Diffusion Current Densities}
 \label{5curdens}
\end{figure}

While deriving an analytical solution for this problem we have assumed that at steady state the drift current density must be equal to the diffusion current density. In figure \ref{5curdens} we see drift and diffusion current densities in log scale. Overall both currents match quite tightly.

\clearpage
\section{Solutions for Open Boundary}
Another very important aspect of drift-diffusion simulation is its transient response. Like the previous test case, we can use a closed form solution to test the accuracy of the transient response. In section 3.3.2 we have found two different analytic solutions for a similar drift diffusion problems which involved infinite boundaries and a uniform electric field. The only difference between two cases are their initial carrier distribution. One has a rectangular and the other one has a gaussian  initial carrier distribution. Since we have not implemented any way to deal with infinite boundaries we will just simulate these two problems until the carrier distributions gets close to one boundary.  

\begin{figure}[ht]
\centering
\includegraphics[scale=0.8]{5212}
\caption{Gaussian Carrier Distribution Evolving Over time} 
\label{51}
\end{figure}

Figure \ref{51} has the transient response from COMSOL, finite difference and analytical solution. Snapshots of the carrier distributions were taken for each method at different time steps and they were superposed on top of each other. Increasing levels on y axis represent a carrier distributions at a different time starting from the bottom and moving forward in time towards the top. Figure \ref{51} has a gaussian initial carrier distribution. It can be seen from that the transient solution generated by both COMSOL and finite difference are quite close to the analytical solution.

\clearpage
\section{Hybrid Method}

While developing a method for numerically calculating current density we have seen that Scharfatter-Gummel scheme turns into a first order upwind scheme for drift dominant problems. Most of the time first order upwind schemes has a major drawback which is numerical dispersion. This means that we will see diffusion due to numerical error even though it almost does not exist. In order to investigate this issue and look for possible remedies we will use the previous example ,with a much higher electric field, as a starting point  Here in figure \ref{53} we see the transient response of a drift dominant problem. Finite difference has no problem producing an accurate transient response but SG has a fair amount of numerical diffusion.  

\begin{figure}[ht]
\centering
\includegraphics[scale=0.75]{5231}
\caption{Gaussian Carrier Distribution Evolving Over time} 
\label{53}
\end{figure}

We can also look at the differences between finite difference and SG in steady state. In this case as it can be seen from figures \ref{54} and \ref{55} SG produces a solution much closer to the analytical solution. This is not surprising. Both steady state solution and SG scheme has an exponential form. So SG can capture the non-linearity at the boundary much better than finite difference which has linear terms. Also in figure \ref{55} we can see finite difference producing negative carrier density distribution which is not physical and it can easily make the simulation unstable.  


\begin{figure}[!htp]
\centering
\includegraphics[scale=0.75]{5232}
\caption{Steady State Carrier Distribution of a Drift Dominant Problem} 
\label{54}
\end{figure}

\begin{figure}[!htp]
\centering
\includegraphics[scale=0.75]{5233}
\caption{Steady State Carrier Distribution of a Drift Dominant Problem} 
\label{55}
\end{figure}

We can see that both methods have their advantages. It is possible to develop a method where we can switch between two methods to get more accurate results. From the analysis above it seems like in transient cases finite difference method have an advantage and SG is better in steady state where drift and diffusion cancel each other out. We can switch between methods by keeping track of two key properties, closeness to steady state and the non linearity of the final solution. The difference between drift and diffusion currents is a good estimator for closeness to steady state and the ratio of drift velocity to diffusion constant can be used to measure non linearity. We can use following two equations to calculate these parameters.

\begin{equation}
K_1=|\frac{J_{drift}+J_{diff}}{J_{drift}-J_{diff}}|
\end{equation}

\begin{equation}
K_2=\frac{\mu E}{D}=\frac{v}{D}
\end{equation}

$K_1$ will always have a value between 0 and 1 depending on how close drift and diffusion current densities are to each other. When $K_1$ is close to 1 it means that drift and diffusion do not have equal values and opposite signs therefore the simulation is far away from steady state. On the other hand if $K_1$ is close to 0 it means that the simulation is in steady state or close to it.  

$K_2$ is a measure of how non linear the solution is going to be since it appears in an exponential. If this value is between 0 and 2 then the final solution is slightly non linear. As $K_2$ increases further the non linearity becomes stronger.

Now that we have established a way to check closeness to steady state and non linearity of the final solution we can use these to improve the accuracy of our transient and steady state responses. During simulation if $K_1$ is close to 1 it means that we are not close to steady state therefore it is better to use finite difference. When $K_1$ is getting close to zero it is time to check if the final solution is going to be very non linear using $K_2$. If that is the case then we can switch to SG method to calculate the steady state solution. Figure \ref{56} shows the evolution of the transient response over time using this hybrid method. The solution is in transient mode so finite difference is used to calculate the current density. As expected numerical diffusion does not occur and the response is quite close to the analytic solution.

Figures \ref{57} to \ref{60} shows the changes in the concentration over time as the simulation approaches steady state. By looking at the following sequence of figures we can see that finite difference has fluctuation problems and it gets worse over time. At the same time we can see the hybrid method transitioning from finite difference to SG method and not having any fluctuation problems. Finally in steady state plots in figure \ref{61} shows the difference in accuracy at steady state between the hybrid method and finite difference. By mixing two methods we were able to reach higher accuracy without needing to increase the mesh density.

\begin{figure}[ht]
\centering
\includegraphics[scale=0.75]{5234}
\caption{Gaussian Carrier Distribution Evolving Over time} 
\label{56}
\end{figure}

\begin{figure}[ht]
\centering
\includegraphics[scale=0.75]{5235}
\caption{Transient Solution of a Drift Dominant Problem} 
\label{57}
\end{figure}

\begin{figure}[ht]
\centering
\includegraphics[scale=0.75]{5236}
\caption{Transient Solution of a Drift Dominant Problem} 
\label{58}
\end{figure}

\begin{figure}[ht]
\centering
\includegraphics[scale=0.75]{5237}
\caption{Transient Solution of a Drift Dominant Problem } 
\label{59}
\end{figure}

\begin{figure}[ht]
\centering
\includegraphics[scale=0.75]{5238}
\caption{Transient Solution of a Drift Dominant Problem } 
\label{60}
\end{figure}

\begin{figure}[ht]
\centering
\includegraphics[scale=0.75]{5239}
\caption{Steady State Carrier Distribution for a Drift Dominant Problem} 
\label{61}
\end{figure}

\clearpage
\section{PN Junction}
In previous sections of this chapter we have put finite difference drift diffusion model to test. In all the cases we ran before, Poisson's equation was not coupled with drift diffusion equations. In this example we will be testing both drift diffusion and Poisson's equation to see how well they work when they are coupled together. A simple pn junction is quite adequate for this task since it has analytical solutions, under certain assumptions, for electric potential, electric field and net charge.

For the simulation ,the initial hole and electron distributions were determined using mass action law and they were assumed to be constant at the boundaries. Keeping carrier concentrations constant at the boundaries creates a mechanism in which the charge can move in and out of the simulation domain. If the charge density at any time step is higher than the fixed density then the difference will move out of the system. If there is a lack of charge at the boundary then carriers will move in to fill in the gap. Following figure (\ref{npcon}) shows the final result of bringing p and n type materials together. 
 
\begin{figure}[ht]
\centering
\includegraphics[scale=0.8]{5311}
\caption{Electron/hole Concentration of a PN Junction} 
\label{npcon}
\end{figure}

We can see a little mismatch between simulated and analytic concentration densities. Analytic solution have sharp edges and simulated solution does not. This is due to all the assumptions made in order to find an analytic solution. We will be seeing this little mismatch also for electric field, electric potential and net charge .

Since the purpose of this problem is to test Poisson's equation as well, we can look at the final potential distribution due to pn junction. Figure \ref{pnpot} shows the potential distribution for simulated and analytic solution. Close match in electric potential distribution shows that coupled equations can generate fairly accurate solutions.
 
\begin{figure}[!htp]
\centering
\includegraphics[scale=0.7]{5312}
\caption{Potential Distribution of a PN Junction} 
\label{pnpot}
\end{figure}

Calculation of the electric field involves one basic derivative. Since simulated potential is matching the analytic solution quite nicely the electric field should follow a similar pattern. Figure \ref{pnefield} shows that this is indeed the case, simulated electric field matches the calculated electric field.
\begin{figure}[!htp]
\centering
\includegraphics[scale=0.7]{5313}
\caption{Electric Field Distribution of a PN Junction} 
\label{pnefield}
\end{figure}

Finally we can look at the total charge distribution at steady state(\ref{pncd}). Simulated net charge density follows the analytic one except the abrupt changes at two ends. 
\begin{figure}
\centering
\includegraphics[scale=0.8]{5314}
\caption{Total Charge Distribution of a PN Junction} 
\label{pncd}
\end{figure}




\clearpage
\section{Region Specific Particle Density Limit}

In section 4.2.2.3 we have talked about using a Dirichlet boundary condition (J=0) to stop the particle flow into a node. This can be done by precalculating the particle density of concentration restricted nodes at the next time step, setting any influx to zero if the concentration is going to go over the limit and finally calculating the concentration at the next time step using the updated current densities. 

In order to test this method we can use a simple example where we have two particles of the same charge initialized like the figure below (\ref{5412}). One set of particles has a concentration limit of $2 \; 10^{10} \; m^{-3}$ on the right side of the simulation area and no limit on the left side. The other set has no restrictions.
\begin{figure}[!htp]
\centering
\includegraphics[scale=0.7]{5412}
\caption{Initial Particle Density} 
\label{5412}
\end{figure}

This transient simulation was done using a potential as a function of time. For the first half of the simulation applied potential was positive and for the second half it was negative. Figure \ref{5412} shows how two simulations differ when the particles are pushed towards the right wall due to the electric field created by the positive potential. Particles with no limit on the right side move freely and accumulate on the right side. The limit for the other particles is effectively stopping them from going in and accumulating freely. Once the limit is reached at a certain node the concentration cannot increase any further and that node becomes a no flow wall. 

\begin{figure}[!htp]
\centering
\includegraphics[scale=0.7]{5413}
\caption{Limited Concentration Accumulation on the Right Side} 
\label{5413}
\end{figure}

When the potential is switched all the particles accumulate freely to the left side of the simulation domain since there are no restrictions on this side (figure \ref{5414}).
\begin{figure}[!htp]
\centering
\includegraphics[scale=0.7]{5414}
\caption{Limited Concentration Accumulation on the Left Side} 
\label{5414}
\end{figure}

This last figure (\ref{5411}) shows the transient response  over time of a single node on the right side. The potential is positive for the first 1.5 seconds and it is switched to negative for the last 1.5 seconds. The node without limit keeps accepting charge until steady state has been reached but the node with a limit on stops accepting charged particles once the limit is reached. After the potential is switched density limited node has no problem releasing the particles.


\begin{figure}[!htp]
\centering
\includegraphics[scale=0.7]{5411}
\caption{Accumulation at the right wall over time} 
\label{5411}
\end{figure}

Additional to the test we ran using finite difference we can also try to simulate the exact same behaviour in COMSOL. 

COMSOL does not have a built in option that allows limiting particle density. One possible solution to this is making particle mobility and diffusivity a function particle density. It is possible to use a sigmoid function which switches from 1 to 0 very quickly when particle density is close to its limit. Here is the equation of the sigmoid function used to limit the particle flow:

\begin{equation}
\mu = \frac{\mu_{0}}{1+e^{\sigma(n-n')}}
\label{mur}
\end{equation} 

$\mu_0$ is the original mobility of the charge carrier. $\sigma$ controls the sharpness of the switch and $n'$ determines the density at which the switch will be. 

Another problem with COMSOL was the definition of mobility and diffusion coefficients over different areas. If these constants are defined as one single value per area it works just fine but if they are defined as a function of concentration it causes convergence issues. This can be overcome by defining using two more sigmoid functions to distinguish between two areas with different mobilities and diffusion constants. Left sigmoid in figure \ref{5420}  was multiplied by the mobility/diffusivity of the left side of the area and the right sigmoid was multiplied by the mobility/diffusivity of the right side of the area. Both functions were summed to obtain a function which describes the characteristics of the entire area.

\begin{equation}
\mu=\frac{\mu_{l}}{1+e^{\sigma_x(x-x')}}+\frac{\mu_{r}}{1+e^{-\sigma_x(x-x')}}
\end{equation}

In this problem $\mu_r$ is the same as equation \ref{mur} since the region on the right side has a particle density limit. A sharp switch between right and left side mobility using the function above would be ideal for this simulation but unfortunately it causes convergence issues in COMSOL therefore there is a gradual change between two mobilities. 

\begin{figure}[!htp]
\centering
\includegraphics[scale=0.7]{5420}
\caption{Mobility change from left to right side} 
\label{5420}
\end{figure}

The initial carrier distribution for COMSOL was set to be exactly the same as finite difference simulation. Figures \ref{5416} and \ref{5423} show results for both COMSOL and finite difference simulations at steady state before the potential switch. The plot on the left side gives insight on how COMSOL simulation behaves for limited and limitless accumulation on the right wall. Due to the gradual change of mobility and diffusion constants between two areas we end up with concentration on the right side higher than the limit which is $2 \; 10^{10}$. Additionally, the particle density goes over its limit near the right wall. In figure \ref{5423} the difference between COMSOL and finite difference becomes more visible. In FD simulation the accumulation goes much higher due to higher electric field and unlike COMSOL it does not penetrate the right half of the simulation domain. 

\begin{figure}[ht]
\centering
\begin{minipage}[b]{0.45\linewidth}
\includegraphics[scale=0.45]{5416}
\caption{COMSOL Simulation for Particle Density Limit}
\label{5416}
\end{minipage}
\quad
\begin{minipage}[b]{0.45\linewidth}
\includegraphics[scale=0.45]{5423}
\caption{COMSOL and Finite Difference Simulation}
\label{5423}
\end{minipage}
\end{figure}


In figure \ref{5417} we can see the accumulation of charge near the middle after the potential is switched. This is due to mobility being a function of distance and concentration. As the ions move from left to right they go from a low mobility region to a high mobility region and they slowly accumulate around the area where the change in mobility occurs. Figure comparing both COMSOL and finite difference shows that the accumulation does not happen in the case of finite difference due to the way concentration limiting mechanism was implemented.

\begin{figure}[ht]
\centering
\begin{minipage}[b]{0.45\linewidth}
\includegraphics[scale=0.45]{5417}
\caption{COMSOL Simulation for Particle Density Limit}
\label{5417}
\end{minipage}
\quad
\begin{minipage}[b]{0.45\linewidth}
\includegraphics[scale=0.45]{5424}
\caption{COMSOL and Finite Difference Simulation}
\label{5424}
\end{minipage}
\end{figure}

With the decrease of ion concentration on the limited region the difference between low and high mobility regions diminish. Once the concentration on the limited side is low enough the whole system behaves as if there was no limit and ion mobility becomes equal for all regions and the ions freely accumulate on the left wall (figure \ref{5418}). Aside from the difference in electric field strength both simulations behave the same way as they approach steady state. Figure \ref{5426} shows concentration densities at steady state. COMSOL simulation has a lower electric field since it has convergence issues with high electric fields. 

\begin{figure}[ht]
\centering
\begin{minipage}[b]{0.45\linewidth}
\includegraphics[scale=0.45]{5418}
\caption{COMSOL Simulation for Particle Density Limit}
\label{5418}
\end{minipage}
\quad
\begin{minipage}[b]{0.45\linewidth}
\includegraphics[scale=0.45]{5426}
\caption{COMSOL and Finite Difference Simulation}
\label{5426}
\end{minipage}
\end{figure}

To finish our comparison we can look at the particle density transient response of the rightmost node. For the first half of the simulation everything is the same as the finite difference case except COMSOL goes a little bit over the limit. When the potential is switched node without the limit has no noticeable difference in behaviour. The node with concentration limit has a lag when it comes to releasing the particles. This is due to the sigmoid function used to achieve a limiting behaviour. Once the limit is reached mobility and diffusivity are stuck at a very low value until the particle density starts to go lower than the limit.
\begin{figure}[ht]
\centering
\begin{minipage}[b]{0.45\linewidth}
\includegraphics[scale=0.45]{5419}
\caption{Density on the right wall over time using COMSOL}
\label{5419}
\end{minipage}
\quad
\begin{minipage}[b]{0.45\linewidth}
\includegraphics[scale=0.45]{5421}
\caption{Density on the right wall over time,COMSOL vs. Finite Difference}
\label{5421}
\end{minipage}
\end{figure}

In this example we have seen that it is possible to impose a density limit over any area using a simple no flow boundary condition in finite difference. For COMSOL we had to use some workarounds in order to simulate the same behavior but the results were not very satisfying because of convergence issues.